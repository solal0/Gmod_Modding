<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GMod Modding Key System</title>
<style>
body { font-family: Arial, sans-serif; background:#121212; color:#f0f0f0; text-align:center; margin-top:60px; }
.card { background:#1e1e1e; border-radius:12px; padding:20px; width:320px; margin:auto; box-shadow:0 0 10px #0008; }
input,button { width:90%; padding:10px; margin:8px; border-radius:6px; border:none; }
input { background:#2a2a2a; color:#fff; }
button { background:#007bff; color:#fff; cursor:pointer; }
button:hover { background:#005ec9; }
</style>
</head>
<body>

<div class="card" id="auth">
<h2>Login / Signup</h2>
<input id="username" placeholder="Username" />
<input id="password" type="password" placeholder="Password" />
<button onclick="signup()">Signup</button>
<button onclick="login()">Login</button>
<p style="font-size:12px;color:#aaa;">Username is unique and permanent.</p>
</div>

<div class="card" id="panel" style="display:none;">
<h2 id="welcome"></h2>
<input id="steamid" placeholder="e.g. STEAM_1:1:775200446" />
<button onclick="generateKey()">Generate / Update Key</button>
<p><strong>Generated Key:</strong> <span id="keyDisplay">None</span></p>
<button onclick="logout()">Logout</button>
</div>

<script>
const API_URL = "/.netlify/functions/generate-key";
let currentUser = null;

// Auto-login
if(localStorage.getItem("currentUser")){
  const saved = JSON.parse(localStorage.getItem("currentUser"));
  autoLogin(saved.username, saved.password);
}

function signup(){
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  if(!u||!p) return alert("Fill all fields.");
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:u,password:p,steamid:""})
  }).then(r=>r.json()).then(data=>{
    if(data.error) return alert(data.error);
    alert("Signup complete! Now login.");
  });
}

function login(){
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  if(!u||!p) return alert("Fill all fields.");
  autoLogin(u,p);
}

function autoLogin(username,password){
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,password,steamid:""})
  }).then(r=>r.json()).then(data=>{
    if(data.error) return alert(data.error);
    currentUser = { username, password };
    localStorage.setItem("currentUser",JSON.stringify(currentUser));
    document.getElementById("auth").style.display="none";
    document.getElementById("panel").style.display="block";
    document.getElementById("welcome").innerText="Welcome, "+username;
    document.getElementById("steamid").value=data.steamid||"";
    document.getElementById("keyDisplay").innerText=data.generated_key||"None";
  });
}

function generateKey(){
  if(!currentUser) return;
  const steamid = document.getElementById("steamid").value.trim();
  if(!steamid) return alert("Enter your SteamID.");
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({...currentUser, steamid})
  }).then(r=>r.json()).then(data=>{
    if(data.error) return alert(data.error);
    document.getElementById("keyDisplay").innerText=data.generated_key;
    document.getElementById("steamid").value=data.steamid;
    alert("Key generated/updated!");
  });
}

function logout(){
  currentUser=null;
  localStorage.removeItem("currentUser");
  document.getElementById("panel").style.display="none";
  document.getElementById("auth").style.display="block";
}
</script>

</body>
</html>
