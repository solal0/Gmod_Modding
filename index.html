<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GMOD Modding Verification System</title>
<style>
:root{
  --bg:#070708;
  --panel:#0f1112;
  --muted:#9aa0a6;
  --accent:#ffffff;
  --success:#2ecc71;
  --danger:#ff6b6b;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#070708,#0a0b0c);color:var(--accent)}
.wrapper{width:100%;max-width:560px;padding:28px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02);text-align:center}
h1{font-size:20px;margin:0 0 8px;font-weight:700}
#sub{color:var(--muted);font-size:13px;margin:0 0 20px}
.popup {z-index: 9999;}
.counter{font-size:28px;font-weight:700;margin-bottom:18px}
.btn{background:#fff;color:#000;padding:12px 18px;border-radius:10px;border:0;font-weight:700;cursor:pointer;min-width:140px}
.btn[disabled]{opacity:.45;cursor:not-allowed;filter:grayscale(.2)}
.small{font-size:13px;color:var(--muted);margin-top:12px}
.popup{position:fixed;left:50%;transform:translateX(-50%);top:18px;background:rgba(0,0,0,0.8);padding:12px 18px;border-radius:10px;color:#fff;border:1px solid rgba(255,255,255,0.04);opacity:0;pointer-events:none;transition:all .25s ease}
.popup.show{opacity:1;top:28px;pointer-events:auto}
.popup.success{background:linear-gradient(90deg,var(--success),#1fbf59)}
.popup.fail{background:linear-gradient(90deg,var(--danger),#e25858)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.modal{background:var(--panel);padding:18px;border-radius:12px;max-width:520px;width:92%;border:1px solid rgba(255,255,255,0.03);text-align:left}
.row{display:flex;gap:10px;align-items:center}
input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:var(--accent);outline:none}
.profile{margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted)}
.lock{font-size:13px;color:var(--muted);margin-top:12px}
.center{display:flex;justify-content:center;gap:10px}
a.linklike{background:none;border:0;color:var(--accent);text-decoration:underline;cursor:pointer;padding:0}
@media(max-width:420px){.counter{font-size:22px}.btn{min-width:120px;padding:10px 14px}}
</style>
</head>
<body>
<div class="popup" id="popup"></div>
<div class="wrapper" id="main">
  <h1>GMOD Modding Verification System</h1>
  <div class="counter" id="progress">1/3</div>
  <div style="display:flex;justify-content:center">
    <button id="verifyBtn" class="btn">Verify</button>
  </div>
  <div class="small" id="hint">Click Verify to open the step link, once completed you'll get redirected back here.</div>
  <div class="lock" id="lockMsg" style="display:none"></div>
</div>

<div id="overlay" style="display:none">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="font-weight:700;margin-bottom:8px">Enter your SteamID64 (https://steamid.xyz/)</div>
    <div class="row">
      <input id="steamInput" type="text" placeholder="7656119xxxxxxxxxx" />
      <button id="validateBtn" class="btn" disabled>Validate</button>
    </div>
    <div id="profileBox" class="profile" style="display:none"></div>
    <div style="margin-top:12px;text-align:right">
      <button id="closeModal" class="btn" style="background:rgba(255,255,255,0.06);color:var(--muted)">Cancel</button>
    </div>
  </div>
</div>

<script>
const WORK_LINKS = [
  "https://workink.net/1R5C/w7gwq9rg",
  "https://workink.net/1R5C/uayzqm9s",
  "https://workink.net/1R5C/qxeqtcuq"
];
const ALLOWED_PREFIX = "https://work.ink";
const API = "https://linkvertise-verifier.linkvertise-verifier-gmod.workers.dev";
const popupEl = document.getElementById("popup");
const verifyBtn = document.getElementById("verifyBtn");
const progressEl = document.getElementById("progress");
const hintEl = document.getElementById("hint");
const lockMsg = document.getElementById("lockMsg");
const overlay = document.getElementById("overlay");
const steamInput = document.getElementById("steamInput");
const validateBtn = document.getElementById("validateBtn");
const profileBox = document.getElementById("profileBox");
let progress = parseInt(localStorage.getItem("gv_progress")||"0",10);
let lockUntil = parseInt(localStorage.getItem("gv_locked_until")||"0",10);
let openStep = parseInt(localStorage.getItem("gv_open_step")||"-1",10);

function render(){
  if(Date.now() < lockUntil){
    verifyBtn.disabled = true;
    lockMsg.style.display = "block";
    const sec = Math.ceil((lockUntil - Date.now())/1000);
    lockMsg.textContent = "You already verified. Access resets every 24h, yours in: "+sec+"s";
    progressEl.textContent = "Locked";
    hintEl.style.display = "none";
    return;
  } else {
    lockMsg.style.display = "none";
  }
  if(progress >= 3){
    progressEl.textContent = "3/3";
    verifyBtn.textContent = "Continue";
    verifyBtn.disabled = false;
  } else {
    progressEl.textContent = (progress+1)+"/3";
    verifyBtn.textContent = "Verify";
    verifyBtn.disabled = false;
  }
}
function showPopup(msg, type){
  popupEl.textContent = msg;
  popupEl.className = "popup "+(type==="ok"?"success":"fail");
  popupEl.classList.add("show");
  setTimeout(()=>{ popupEl.classList.remove("show"); },5000);
}
function tryDetectReturn(){
  const opened = parseInt(localStorage.getItem("gv_open_step")||"-1",10);
  if(opened===-1) return;
  let came = false;
  const ref = (document.referrer||"").trim();
  if(ref && ref.startsWith(ALLOWED_PREFIX)) came = true;
  if(!came && performance && performance.getEntriesByType){
    try{
      const nav = performance.getEntriesByType("navigation");
      if(nav && nav.length){
        const n = nav[0];
        if(n && n.name && n.name.startsWith(ALLOWED_PREFIX)) came = true;
      }
    }catch(e){}
  }
  if(came && opened===progress){
    progress = progress+1;
    localStorage.setItem("gv_progress",String(progress));
    localStorage.removeItem("gv_open_step");
    showPopup("Verification was a success !","ok");
    render();
  } else if(!came){
    showPopup("Verification failed, please retry by clicking Verify.","fail");
    localStorage.removeItem("gv_open_step");
    localStorage.removeItem("gv_open_time");
  }
}
verifyBtn.addEventListener("click",()=>{
  if(Date.now() < lockUntil) return;
  if(progress < 3){
    localStorage.setItem("gv_open_step",String(progress));
    localStorage.setItem("gv_open_time",String(Date.now()));
    window.open(WORK_LINKS[progress],"_blank","noopener");
  } else {
    overlay.style.display = "flex";
    steamInput.value = "";
    profileBox.style.display = "none";
    validateBtn.disabled = true;
  }
});
document.addEventListener("visibilitychange",()=>{
  if(document.visibilityState==="visible") tryDetectReturn();
});
window.addEventListener("focus", tryDetectReturn);
window.addEventListener("load",()=>{
  render();
  tryDetectReturn();
});
function isSteam64(v){ return /^[0-9]{17}$/.test(v); }
steamInput.addEventListener("input",()=>{
  validateBtn.disabled = !isSteam64(steamInput.value.trim());
});
validateBtn.addEventListener("click",async()=>{
  const sid = steamInput.value.trim();
  if(!isSteam64(sid)) return;
  validateBtn.disabled = true;
  validateBtn.textContent = "Validating...";
  try{
    const res = await fetch(API.replace(/\/$/,"")+"/api/verify", { method:"POST", headers:{"content-type":"application/json"}, body: JSON.stringify({ steamid: sid }) });
    const data = await res.json();
    if(res.ok && data && data.ok){
      profileBox.style.display = "block";
      profileBox.innerHTML = "<div style='font-weight:700;color:#fff'>Profile found</div><div style='margin-top:8px;color:var(--muted)'>"+(data.profile&&data.profile.steamID?escapeHtml(data.profile.steamID):escapeHtml(sid))+"</div>";
      localStorage.setItem("gv_locked_until", String(Date.now()+(24*3600*1000)));
      localStorage.removeItem("gv_progress");
      localStorage.removeItem("gv_open_step");
      lockUntil = parseInt(localStorage.getItem("gv_locked_until")||"0",10);
      setTimeout(()=>{ overlay.style.display="none"; render(); },800);
    } else {
      profileBox.style.display = "block";
      profileBox.innerHTML = "<div style='color:var(--danger);font-weight:700'>Account not found or verification failed</div>";
      validateBtn.disabled = false;
      validateBtn.textContent = "Validate";
    }
  }catch(e){
    profileBox.style.display = "block";
    profileBox.innerHTML = "<div style='color:var(--danger);font-weight:700'>Network error</div>";
    validateBtn.disabled = false;
    validateBtn.textContent = "Validate";
  }
});
document.getElementById("closeModal").addEventListener("click",()=>{ overlay.style.display="none"; render(); });
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }
</script>
</body>
</html>
